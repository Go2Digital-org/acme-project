[unix_http_server]
file=/run/supervisord.sock
chmod=0700

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/run/supervisord.pid
childlogdir=/var/log/supervisor
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///run/supervisord.sock

; ================================================================
; FrankenPHP + Laravel Octane - Main Application Server
; ================================================================
[program:frankenphp-octane]
command=frankenphp run --config /etc/caddy/Caddyfile
directory=/app
user=www-data
autostart=true
autorestart=true
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/frankenphp-octane.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/var/log/supervisor/frankenphp-octane-error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
environment=
    PATH="/usr/local/bin:/usr/bin:/bin",
    APP_ENV="production",
    OCTANE_SERVER="frankenphp",
    OCTANE_HOST="0.0.0.0",
    OCTANE_PORT="80",
    OCTANE_WORKERS="auto",
    OCTANE_MAX_REQUESTS="1000"
priority=100
stopsignal=TERM
stopwaitsecs=30

; ================================================================
; Laravel Horizon - Queue Management
; ================================================================
[program:queue-default]
command=php artisan queue:work redis --queue=default --tries=3 --max-time=0 --max-jobs=100 --memory=128 --timeout=60 --sleep=3
directory=/app
user=www-data
autostart=true
autorestart=true
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/queue-default.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/var/log/supervisor/queue-default-error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
environment=
    PATH="/usr/local/bin:/usr/bin:/bin"
priority=200
stopsignal=TERM
stopwaitsecs=60
stopasgroup=true
killasgroup=true

[program:queue-high-priority]
command=php artisan queue:work redis --queue=payments,notifications --tries=5 --max-time=0 --max-jobs=500 --memory=256 --timeout=180 --sleep=1
directory=/app
user=www-data
autostart=true
autorestart=true
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/queue-high.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/var/log/supervisor/queue-high-error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
environment=
    PATH="/usr/local/bin:/usr/bin:/bin"
priority=201
stopsignal=TERM
stopwaitsecs=180
stopasgroup=true
killasgroup=true

[program:queue-medium-priority]
command=php artisan queue:work redis --queue=reports,exports --tries=3 --max-time=0 --max-jobs=50 --memory=512 --timeout=600 --sleep=5
directory=/app
user=www-data
autostart=true
autorestart=true
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/queue-medium.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/var/log/supervisor/queue-medium-error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
environment=
    PATH="/usr/local/bin:/usr/bin:/bin"
priority=202
stopsignal=TERM
stopwaitsecs=600
stopasgroup=true
killasgroup=true

[program:queue-low-priority]
command=php artisan queue:work redis --queue=bulk,maintenance --tries=1 --max-time=0 --max-jobs=10 --memory=1024 --timeout=3600 --sleep=10
directory=/app
user=www-data
autostart=true
autorestart=true
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/queue-low.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/var/log/supervisor/queue-low-error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
environment=
    PATH="/usr/local/bin:/usr/bin:/bin"
priority=203
stopsignal=TERM
stopwaitsecs=3600
stopasgroup=true
killasgroup=true

; ================================================================
; Laravel Scheduler - Cron Jobs
; ================================================================
[program:scheduler]
command=/bin/sh -c "while true; do php artisan schedule:run --verbose --no-interaction; sleep 60; done"
directory=/app
user=www-data
autostart=true
autorestart=true
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/scheduler.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/var/log/supervisor/scheduler-error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
environment=
    PATH="/usr/local/bin:/usr/bin:/bin"
priority=300
stopsignal=TERM
stopwaitsecs=60

; ================================================================
; Laravel Reverb - WebSocket Server (if needed)
; ================================================================
[program:reverb]
command=php artisan reverb:start --host=0.0.0.0 --port=8080
directory=/app
user=www-data
autostart=false
autorestart=true
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/reverb.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/var/log/supervisor/reverb-error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
environment=
    PATH="/usr/local/bin:/usr/bin:/bin"
priority=400
stopsignal=TERM
stopwaitsecs=30

; ================================================================
; Health Check Service
; ================================================================
[program:health-check]
command=/bin/sh -c "while true; do curl -f http://localhost/health > /dev/null 2>&1 || echo 'Health check failed'; sleep 30; done"
directory=/app
user=www-data
autostart=true
autorestart=true
startretries=3
redirect_stderr=true
stdout_logfile=/var/log/supervisor/health-check.log
stdout_logfile_maxbytes=10MB
stdout_logfile_backups=5
stderr_logfile=/var/log/supervisor/health-check-error.log
stderr_logfile_maxbytes=10MB
stderr_logfile_backups=5
priority=999
stopsignal=TERM
stopwaitsecs=10

; ================================================================
; Group Configuration - Start/Stop Related Services Together
; ================================================================
[group:laravel]
programs=frankenphp-octane,queue-default,queue-high-priority,queue-medium-priority,queue-low-priority,scheduler
priority=100

[group:monitoring]
programs=health-check
priority=999

; ================================================================
; Event Listeners (commented out for now to avoid parsing issues)
; ================================================================
; [eventlistener:supervisor_events]
; command=/usr/bin/python3 -c "import sys; from supervisor.childutils import listener; [listener.ok(sys.stdout) for headers, payload in [listener.wait(sys.stdin, sys.stdout)]]"
; events=PROCESS_STATE_FATAL,PROCESS_STATE_EXITED
; autostart=false
; autorestart=false